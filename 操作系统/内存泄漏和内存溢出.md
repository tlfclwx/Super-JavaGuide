# 内存泄漏和内存溢出

## 内存溢出

指程序在申请内存时，没有足够的空间使用。比如申请了一个integer，但给它存了long才能存下的数，那就是内存溢出。内存溢出就是你要求分配的内存超出了系统能给你的，系统不能满足需求，于是产生溢出。

### 内存溢出的可能原因

- 内存中加载的数据量过于庞大，以至于一次性存不下
- 死循环或者过多次数的递归
- 启动参数内存设置的过小
- 对象引用没有回收，导致jvm gc无法回收，从而减少了可用的内存



### 内存溢出的解决方案

第一步，直接增加内存

第二步，检查错误日志，查看“OutOfMemory”错误前是否有其它异常或错误。

第三步，对代码进行走查和分析，找出可能发生内存溢出的位置。



重点排查以下几点：

1.检查对数据库查询中，是否有一次获得全部数据的查询。一般来说，如果一次取十万条记录到内存，就可能引起内存溢出。这个问题比较隐蔽，在上线前，数据库中数据较少，不容易出问题，上线后，数据库中数据多了，一次查询就有可能引起内存溢出。因此对于==**数据库查询尽量采用分页的方式查询**==。

2.检查代码中是否有死循环或递归调用。

3.检查是否有大循环重复产生新对象实体。

4.检查List、MAP等集合对象是否有使用完后，未清除的问题。List、MAP等集合对象会始终存有对对象的引用，使得这些对象不能被GC回收。



第四步，使用内存查看工具动态查看内存使用情况

## 内存泄漏

指你向系统申请分配内存使用(new)，可是使用完了以后却不归还(free)，结果你申请到的那块内存不能再次访问使用(你把内存地址弄丢了)，而系统也不能再次将他分配给需要的程序。一次内存泄露危害可以忽略，但内存泄露的堆积后果非常严重，无论多少内存迟早会被吃光。memory leak会最终会导致out of memory！

### 内存泄漏的分类**以发生的方式来分类，内存泄漏可以分为4类：**



- 常发性内存泄漏。发生内存泄漏的代码会被多次执行到，每次被执行的时候都会导致一块内存泄漏。
- 偶发性内存泄漏。发生内存泄漏的代码只有在某些特定环境或操作过程下才会发生。常发性和偶发性是相对的。对于特定的环境，偶发性的也许就变成了常发性的。所以测试环境和测试方法对检测内存泄漏至关重要。
- 一次性内存泄漏。发生内存泄漏的代码只会被执行一次，或者由于算法上的缺陷，导致总会有一块仅且一块内存发生泄漏。比如，在类的构造函数中分配内存，在析构函数中却没有释放该内存，所以内存泄漏只会发生一次。
- 隐式内存泄漏。程序在运行过程中不停的分配内存，但是直到结束的时候才释放内存。严格的说这里并没有发生内存泄漏，因为最终程序释放了所有申请的内存。但是对于一个服务器程序，需要运行几天，几周甚至几个月，不及时释放内存也可能导致最终耗尽系统的所有内存。所以，我们称这类内存泄漏为隐式内存泄漏。