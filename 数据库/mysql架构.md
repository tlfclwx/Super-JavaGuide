# mysql架构
[文章](https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&mid=2247485097&idx=1&sn=84c89da477b1338bdf3e9fcd65514ac1&chksm=cea24962f9d5c074d8d3ff1ab04ee8f0d6486e3d015cfd783503685986485c11738ccb542ba7&token=79317275&lang=zh_CN%23rd)
> 讲一下mysql的架构

分为Server层和存储引擎。

Server层有：
- 连接器： 身份认证和权限相关(登录 MySQL 的时候)。
- 查询缓存:  执行查询语句的时候，会先查询缓存（MySQL 8.0 版本后移除，因为这个功能不太实用）。
- 分析器:  没有命中缓存的话，SQL 语句就会经过分析器，分析器说白了就是要先看你的 SQL 语句要干嘛，再检查你的 SQL 语句语法是否正确。
- 优化器： 按照 MySQL 认为最优的方案去执行。
- 执行器:  执行语句，然后从存储引擎返回数据。

存储引擎就是负责数据的存储和读取的，支持innodb和myisam，Memory等多个引擎

## 连接器

连接器主要和身份认证和权限相关的功能相关，就好比一个级别很高的门卫一样。

主要负责用户登录数据库，进行用户的身份认证，包括校验账户密码，权限等操作，如果用户账户密码已通过，连接器会到权限表中查询该用户的所有权限，之后在这个连接里的权限逻辑判断都是会依赖此时读取到的权限数据，也就是说，==后续只要这个连接不断开，即时管理员修改了该用户的权限，该用户也是不受影响的。==

## 查询缓存(MySQL 8.0 版本后移除)
连接建立后，执行查询语句的时候，会先查询缓存，MySQL 会先校验这个 sql 是否执行过，以 Key-Value 的形式缓存在内存中，Key 是查询预计，Value 是结果集。如果缓存 key 被命中，就会直接返回给客户端，如果没有命中，就会执行后续的操作，完成后也会把结果缓存起来，方便下一次调用。当然在真正执行缓存查询的时候还是会校验用户的权限，是否有该表的查询条件。

==MySQL 查询不建议使用缓存，因为查询缓存失效在实际业务场景中可能会非常频繁，假如你对一个表更新的话，这个表上的所有的查询缓存都会被清空。对于不经常更新的数据来说，使用缓存还是可以的。==

## 分析器
MySQL 没有命中缓存，那么就会进入分析器，分析器主要是用来分析 SQL 语句是来干嘛的，分析器也会分为几步：

第一步，词法分析，一条 SQL 语句有多个字符串组成，首先要提取关键字，比如 select，提出查询的表，提出字段名，提出查询条件等等。做完这些操作后，就会进入第二步。

第二步，语法分析，主要就是判断你输入的 sql 是否正确，是否符合 MySQL 的语法。

完成这 2 步之后，MySQL 就准备开始执行了，但是如何执行，怎么执行是最好的结果呢？这个时候就需要优化器上场了。

## 优化器

优化器的作用就是它认为的最优的执行方案去执行，比如多个索引的时候该如何选择索引，多表查询的时候如何选择关联顺序等。

可以说，经过了优化器之后可以说这个语句具体该如何执行就已经定下来。

## 执行器

当选择了执行方案后，MySQL 就准备开始执行了，==首先执行前会校验该用户有没有权限，如果没有权限，就会返回错误信息==，如果有权限，就会去调用引擎的接口，返回接口执行的结果。

> sql如何执行一条指令

- 查询
  - 连接器（权限校验）-》查询缓存 -》分析器（分析语法）-》优化器-》执行器-》引擎
- 更新
  - 连接器-》分析器-》优化器-》执行器-》引擎-》redo log prepare -》binlog -》 redo log commit


> 讲一下redo log和binlog怎么保持一致性

先写redo log，然后redo log进入prepare状态并通知执行器，然后执行器写binlog，写完后，标志着事务成功了，然后将redo log commit。


> mysql的事务执行成功的标志是什么

binlog成功写入就代表事务成功了。

> redo log和binlog的作用

redo log是innodb提供的，为了确保事务的持久性。防止在发生故障后，有数据还未写入磁盘。

binlog是sql server提供的，为了主从复制。